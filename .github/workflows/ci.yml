name: CI

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]

permissions:
  contents: read

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v3

      - name: Sync Python dependencies
        run: |
          uv python install 3.12
          uv sync --all-groups

      - name: Ruff (lint)
        run: uv run ruff check .

      - name: Ruff (format check)
        run: uv run ruff format --check .

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Node deps
        run: npm ci

      - name: Prettier (check)
        run: npx prettier --check "**/*.{js,jsx,ts,tsx,json,md,yml,yaml,css,scss,html}"

      - name: Pytest (unit)
        env:
          PYTHONWARNINGS: ignore
        run: uv run pytest --maxfail=1 --disable-warnings -q --cov=. --cov-report=xml --junit-xml=junit.xml

      - name: Upload coverage xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Upload junit (if you produce it)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit
          path: junit.xml
          if-no-files-found: ignore

      - name: Notify Microsoft Teams on failure
        if: failure()
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "${TEAMS_WEBHOOK_URL}" ]; then
            echo "No TEAMS_WEBHOOK_URL configured; skipping."
            exit 0
          fi
          SHORT_SHA="${GITHUB_SHA::7}"
          read -r -d '' CARD << EOF
          {
            "@type": "MessageCard",
            "@context": "https://schema.org/extensions",
            "themeColor": "D24D57",
            "summary": "CI failed",
            "title": "âŒ CI failed in ${{ github.workflow }}",
            "sections": [
              {
                "facts": [
                  { "name": "Repo", "value": "${{ github.repository }}" },
                  { "name": "Branch/Ref", "value": "${{ github.ref_name }}" },
                  { "name": "Job", "value": "lint-and-test" },
                  { "name": "Actor", "value": "${{ github.actor }}" },
                  { "name": "Commit", "value": "${SHORT_SHA}" }
                ]
              }
            ],
            "potentialAction": [
              {
                "@type": "OpenUri",
                "name": "View Run",
                "targets": [{ "os": "default", "uri": "${RUN_URL}"}]
              }
            ]
          }
          EOF
          curl -H "Content-Type: application/json" -d "${CARD}" "${TEAMS_WEBHOOK_URL}"
